---
title: "Climate Data Imputation using 5-Day SMA"
author: "Ee Fook Ming"
date: "23 March 2025" 
date-modified: "last-modified"
execute:
  eval: true
  echo: true
  message: false
  freeze: true
  warning: false
---

# Load Libraries

```{r}

pacman::p_load(tidyverse,dplyr, readr, openxlsx, zoo)

```

# 5-Day

```{r}

library(dplyr)
library(readr)
library(openxlsx)

# === Load dataset ===
climate <- read_csv("data/climate_historical_daily_records/climate_final_2018_2024.csv")
original <- climate

# === Columns to impute ===
impute_cols <- c("Daily Rainfall Total (mm)",
                 "Mean Temperature (Celsius)",
                 "Maximum Temperature (Celsius)",
                 "Minimum Temperature (Celsius)",
                 "Mean Wind Speed (km/h)")

# === Backward SMA-5 for first 4 rows ===
# === Backward SMA-5 (recursive fill for rows 4 to 1) ===
for (i in 4:1) {
  window <- climate[(i + 1):(i + 5), impute_cols]
  sma_values <- colMeans(window, na.rm = TRUE) %>% round(1)
  climate[i, impute_cols] <- as.list(sma_values)
}


# === Forward SMA-5 for all other NAs ===
for (col in impute_cols) {
  na_indices <- which(is.na(climate[[col]]))
  for (idx in na_indices) {
    if (idx >= 5) {
      sma_val <- mean(climate[[col]][(idx - 5):(idx - 1)], na.rm = TRUE) %>% round(1)
      if (!is.nan(sma_val)) {
        climate[[col]][idx] <- sma_val
      }
    }
  }
}

# === Save updated CSV ===
write_csv(climate, "data/climate_historical_daily_records/climate_final_2018_2024_5-Day.csv")

# === Prepare Excel with bold + red styling for updated NA values ===
wb <- createWorkbook()
addWorksheet(wb, "Updated_NAs")

# Create red bold style
style_red_bold <- createStyle(textDecoration = "bold", fontColour = "#FF0000")

# Write correct header row in row 1
writeData(wb, "Updated_NAs", as.data.frame(t(colnames(climate))), startRow = 1, colNames = FALSE)

# Write entire dataset starting from row 2
writeData(wb, "Updated_NAs", climate, startRow = 2, colNames = FALSE)

# Apply red + bold style for every updated NA field
for (col_name in impute_cols) {
  col_idx <- which(names(climate) == col_name)
  updated_rows <- which(is.na(original[[col_name]]) & !is.na(climate[[col_name]]))

  if (length(updated_rows) > 0) {
    for (row in updated_rows) {
      addStyle(wb,
               sheet = "Updated_NAs",
               style = style_red_bold,
               rows = row + 1,   # Offset +1 because header is row 1
               cols = col_idx,
               gridExpand = FALSE,
               stack = TRUE)
    }
  }
}

# Save Excel
saveWorkbook(wb, "data/climate_historical_daily_records/NAs_fields_updated_5-Day.xlsx", overwrite = TRUE)

```
